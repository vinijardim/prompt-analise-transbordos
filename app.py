# -*- coding: utf-8 -*-
"""app

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1cdKjfX5qllGzyUDW4jTA3H0cMhG68ax1
"""

import streamlit as st
import pandas as pd
import openai
import json

st.set_page_config(page_title="AnÃ¡lise de Transbordos", layout="centered")

# Interface
st.title("ğŸ” AnÃ¡lise de Transbordos do Chatbot")
st.markdown("Envie uma base com **Assunto** e **Quantidade** de transbordos para anÃ¡lise.")

# API Key
api_key = st.text_input("ğŸ” Chave da OpenAI (sk-...)", type="password")
if api_key:
    openai.api_key = api_key

# Upload do arquivo
arquivo = st.file_uploader("ğŸ“ Envie um arquivo CSV", type="csv")

if arquivo and api_key:
    df = pd.read_csv(arquivo)

    st.subheader("ğŸ‘€ VisualizaÃ§Ã£o dos dados")
    st.dataframe(df)

    # GeraÃ§Ã£o do prompt com base completa
    dados = df.to_dict(orient="records")
    dados_formatados = json.dumps(dados, indent=2, ensure_ascii=False)

    prompt = f"""
VocÃª Ã© um especialista em anÃ¡lise de chatbot. Abaixo estÃ£o os dados com assuntos e quantidades de transbordos registrados no chatbot.

Dados:
{dados_formatados}

Tarefa:
- Liste os assuntos com maiores volumes de transbordos.
- Identifique tendÃªncias ao longo dos meses, se houver.
- Aponte possÃ­veis causas para os assuntos mais crÃ­ticos.
- Sugira melhorias para reduzir os transbordos e melhorar a experiÃªncia do usuÃ¡rio.

Retorne a anÃ¡lise de forma clara, objetiva e com recomendaÃ§Ãµes prÃ¡ticas.
    """

    with st.spinner("Analisando os dados..."):
        try:
            response = openai.chat.completions.create(
                model="gpt-4",
                messages=[
                    {"role": "system", "content": "VocÃª Ã© um especialista em anÃ¡lise de chatbot."},
                    {"role": "user", "content": prompt}
                ]
            )
            resultado = response.choices[0].message.content
            st.subheader("ğŸ“Š Resultado da AnÃ¡lise")
            st.markdown(resultado)

        except Exception as e:
            st.error(f"Erro ao chamar a API: {e}")
else:
    st.info("Para comeÃ§ar, adicione sua chave da OpenAI e envie um arquivo CSV.")